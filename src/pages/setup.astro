---
import { supabase } from '../lib/supabaseClient'
import Layout from '../layouts/Layout.astro'
---
<Layout>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Configuración del ciclo</title>
  </head>
  <body class="p-6 text-center text-lg">
    <h1 class="text-2xl font-bold text-pink-700 mb-4">Configura tu ciclo</h1>

    <form id="form-fecha" class="space-y-4">
      <label for="fecha_inicio">Selecciona tu fecha de inicio del ciclo:</label><br />
      <input
        type="date"
        id="fecha_inicio"
        name="fecha_inicio"
        class="border p-2 rounded"
        required
      /><br />
      <button
        type="submit"
        class="bg-pink-700 text-white px-4 py-2 rounded hover:bg-pink-800"
      >
        Guardar
      </button>
    </form>

    <p id="mensaje" class="mt-4 text-green-600"></p>

    <script type="module">
      import { supabase } from '/src/lib/supabaseClient.ts'

      const form = document.getElementById('form-fecha')
      const mensaje = document.getElementById('mensaje')

      async function cargarFecha() {
        const { data: { session } } = await supabase.auth.getSession()
        if (!session) {
          mensaje.textContent = 'Debes iniciar sesión.'
          return
        }

        const { data } = await supabase
          .from('perfiles')
          .select('fecha_inicio')
          .eq('id', session.user.id)
          .single()

        if (data?.fecha_inicio) {
          document.getElementById('fecha_inicio').value = data.fecha_inicio
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault()
        const fecha = document.getElementById('fecha_inicio').value
        const { data: { session } } = await supabase.auth.getSession()

        if (!session) {
          mensaje.textContent = 'No hay sesión activa.'
          return
        }

        const { data: existe } = await supabase
          .from('perfiles')
          .select('*')
          .eq('id', session.user.id)
          .single()

        let result
        if (existe) {
          result = await supabase
            .from('perfiles')
            .update({ fecha_inicio: fecha })
            .eq('id', session.user.id)
        } else {
          result = await supabase
            .from('perfiles')
            .insert([{ id: session.user.id, fecha_inicio: fecha }])
        }

        if (result.error) {
          mensaje.textContent = 'Error: ' + result.error.message
        } else {
          mensaje.textContent = 'Fecha guardada. Redirigiendo...'
          setTimeout(() => {
            window.location.href = '/dashboard'
          }, 1500)
        }
      })

      cargarFecha()
    </script>
  </body>
</html>
</Layout>