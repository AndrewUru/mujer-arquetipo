---
import Layout from '../layouts/Layout.astro'
---

<Layout>
  <div id="contenido" class="p-6 max-w-xl mx-auto text-center font-sans bg-pink-50 text-pink-900 min-h-screen">
    <h1 class="text-3xl font-bold mb-2">Cargando...</h1>
    <p class="text-lg mb-6">Esp√©ranos un momento ‚ú®</p>
  </div>

<script type="module">
  import { supabase } from "/scripts/supabaseClient.js";

  const contenido = document.getElementById('contenido');

  async function cargarDashboard() {
    const { data: { session }, error } = await supabase.auth.getSession();

      if (!session?.user) {
        contenido.innerHTML = `
          <h1 class="text-3xl font-bold text-red-600">Error de sesi√≥n</h1>
          <p>Por favor, inicia sesi√≥n nuevamente.</p>
        `
        return
      }

      const user = session.user
      const { data: perfil, error: errorPerfil } = await supabase
        .from('perfiles')
        .select('fecha_inicio')
        .eq('id', user.id)
        .single()

      if (!perfil?.fecha_inicio) {
        contenido.innerHTML = `
          <h1 class="text-2xl font-bold mb-4">Hola, <span class="text-pink-700">${user.email}</span></h1>
          <div class="bg-yellow-100 border border-yellow-400 p-4 rounded-xl text-yellow-800">
            ‚ú® A√∫n no has configurado tu ciclo.
            <br /><br />
            <a href="/setup" class="bg-pink-700 text-white px-4 py-2 rounded-lg hover:bg-pink-800 inline-block">
              Configurar ahora
            </a>
          </div>
        `
        return
      }

      const fechaInicio = new Date(perfil.fecha_inicio)
      const hoy = new Date()
      const diffTime = hoy.getTime() - fechaInicio.getTime()
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))
      const diaCiclo = (diffDays % 28) + 1

      const { data: contenidoDia, error: errorContenido } = await supabase
        .from('mujer_chakana')
        .select('*')
        .eq('dia_ciclo', diaCiclo)
        .single()

      contenido.innerHTML = `
        <h1 class="text-3xl font-bold mb-2">Hola, <span class="text-pink-700">${user.email}</span></h1>
        <p class="text-lg mb-6">Est√°s en el <strong>d√≠a ${diaCiclo}</strong> de tu ciclo de 28 d√≠as.</p>

        ${contenidoDia ? `
          <div class="bg-pink-100 rounded-xl p-4 shadow-md mb-6 text-left">
            <h2 class="text-2xl font-semibold mb-1">üåï D√≠a ${contenidoDia.dia_ciclo} ¬∑ ${contenidoDia.arquetipo}</h2>
            <p class="text-pink-800 mb-2">${contenidoDia.descripcion}</p>
            <p class="text-sm mb-1"><strong>Elemento:</strong> ${contenidoDia.elemento}</p>
            <p class="text-sm mb-2"><strong>Tip del d√≠a:</strong> ${contenidoDia.tip_extra}</p>

            ${contenidoDia.audio_url ? `
              <audio controls class="w-full mt-2 mb-2">
                <source src="${contenidoDia.audio_url}" type="audio/mpeg">
                Tu navegador no soporta audio HTML5.
              </audio>` : ''}

            ${contenidoDia.ritual_pdf ? `
              <a href="${contenidoDia.ritual_pdf}" target="_blank"
                class="mt-2 inline-block text-pink-700 underline text-sm">
                üìú Ver ritual del d√≠a
              </a>` : ''}
          </div>` : `
          <p class="text-gray-600 mb-6">No se encontr√≥ contenido para este d√≠a.</p>`}

        <div class="grid grid-cols-7 gap-2 text-sm text-gray-800 mb-8">
          ${Array.from({ length: 28 }, (_, i) => `
            <div class="p-2 rounded-full ${i + 1 === diaCiclo ? 'bg-pink-700 text-white font-bold' : 'bg-pink-200'}">
              ${i + 1}
            </div>
          `).join('')}
        </div>

        <form id="form-nota" class="text-left space-y-4 mb-10">
          <label for="nota" class="block text-sm font-medium text-pink-800">
            ‚úçÔ∏è ¬øQu√© sentiste hoy?
          </label>
          <textarea id="nota" name="nota" rows="4"
            class="w-full p-3 border border-pink-300 rounded-lg shadow-sm"
            placeholder="Escribe una nota personal sobre este d√≠a..."></textarea>
          <button type="submit" class="bg-pink-700 text-white px-4 py-2 rounded-lg hover:bg-pink-800">
            Guardar nota
          </button>
          <p id="mensaje-nota" class="text-green-700 font-medium"></p>
        </form>

        <a href="/setup" class="text-sm text-pink-600 underline">Cambiar fecha de inicio</a>
      `

      // Guardar nota
      const form = document.getElementById('form-nota')
      const nota = document.getElementById('nota')
      const mensaje = document.getElementById('mensaje-nota')

      form?.addEventListener('submit', async (e) => {
        e.preventDefault()

        const { error } = await supabase
          .from('notas')
          .upsert({
            usuario_id: user.id,
            dia_ciclo: diaCiclo,
            texto: nota.value,
            fecha: new Date().toISOString()
          })

        if (error) {
          mensaje.textContent = 'Hubo un error al guardar la nota.'
          console.error(error)
        } else {
          mensaje.textContent = 'Nota guardada correctamente ‚ú®'
          nota.value = ''
        }
      })
    }

    cargarDashboard()
  </script>
</Layout>
